variables:
  TEST_BRANCH: "ci-test/${CI_COMMIT_SHA}"

prepare_td:
  stage: .pre
  tags:
    - bb5
  script:
    - git clone --depth=1 "https://oauth2:${TD_TOKEN}@bbpgitlab.epfl.ch/hpc/touchdetector.git"
    - cd touchdetector
    - git checkout -b "${TEST_BRANCH}"
    - 'sed -i -e "/project:\s*hpc\/gitlab-pipelines/ a\    ref: ${CI_COMMIT_SHA}" .gitlab-ci.yml'
    - git commit -a -m "Autogenerated by your CI" --author "${GITLAB_USER_NAME} <${GITLAB_USER_EMAIL}>"
    - git push origin "${TEST_BRANCH}"

reproduce:
  stage: build
  tags:
    - bb5
  script:
    - sed -e "s#@TD_TEST_BRANCH@#${TEST_BRANCH}#g" .gitlab-ci.children.yml > children.yml
  artifacts:
    paths:
      - children.yml

offspring:
  stage: test
  trigger:
    include:
      - artifact: children.yml
        job: reproduce
    strategy: depend

cleanup_td:
  stage: .post
  when: always
  tags:
    - bb5
  script:
    - git clone --depth=1 "https://oauth2:${TD_TOKEN}@bbpgitlab.epfl.ch/hpc/touchdetector.git"
    - cd touchdetector
    - git push origin --delete "${TEST_BRANCH}"
