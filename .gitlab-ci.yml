variables:
  # All the jobs in this pipeline do is play with git and sed...
  bb5_memory: 512M
  bb5_constraint: knl
  bb5_cpus_per_task: 1
  bb5_duration: "10:00"
  bb5_build_dir: pipeline # CI_BUILDS_DIR will be the same for all jobs
  TEST_BRANCH: "ci-test/${CI_COMMIT_SHA}"

default:
  # Use an account that maps will switch users depending on the repo it
  # runs on
  tags: [bb5_map]

.prepare_project:
  stage: .pre
  variables:
    GIT_STRATEGY: none
    GIT_CLONE_PATH: ${CI_BUILDS_DIR}/${gitlab_project_to_prepare}
  script:
    - git clone --depth=1 "https://oauth2:${gitlab_project_token}@bbpgitlab.epfl.ch/${gitlab_project_to_prepare}.git" .
    - git checkout -b "${TEST_BRANCH}"
    - 'sed -i -e "/project:\s*hpc\/gitlab-pipelines/ a\    ref: ${CI_COMMIT_SHA}" .gitlab-ci.yml'
    - git commit -a -m "Autogenerated by your CI [skip ci]" --author "${GITLAB_USER_NAME} <${GITLAB_USER_EMAIL}>"
    - git push origin "${TEST_BRANCH}"

.cleanup_project:
  stage: .post
  when: always
  extends: [.prepare_project]
  script:
    - git status
    - git push origin --delete "${TEST_BRANCH}"

.td_config:
  variables:
    gitlab_project_token: ${TD_TOKEN}
    gitlab_project_to_prepare: hpc/touchdetector

.coreneuron_config:
  variables:
    gitlab_project_token: ${CORENEURON_TOKEN}
    gitlab_project_to_prepare: hpc/coreneuron

prepare_td:
  extends:
    - .prepare_project
    - .td_config
prepare_coreneuron:
  extends:
    - .prepare_project
    - .coreneuron_config

reproduce:
  stage: build
  script:
    - sed -e "s#@TEST_BRANCH@#${TEST_BRANCH}#g" .gitlab-ci.children.yml > children.yml
  artifacts:
    paths:
      - children.yml

offspring:
  stage: test
  variables:
    # Child pipelines might take a while.
    bb5_duration: "1:00:00"
  trigger:
    include:
      - artifact: children.yml
        job: reproduce
    strategy: depend

cleanup_td:
  extends:
    - .cleanup_project
    - .td_config

cleanup_coreneuron:
  extends:
    - .cleanup_project
    - .coreneuron_config
